rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isLandlordForListing(listingId) {
      return isSignedIn()
        && get(/databases/$(database)/documents/listings/$(listingId)).data.landlordId == request.auth.uid;
    }

    function isUniqueViewIncrement() {
      let currentViews = resource.data.uniqueViewCount is int ? resource.data.uniqueViewCount : 0;
      let changedKeys = request.resource.data.diff(resource.data).changedKeys();
      return changedKeys.hasOnly(["uniqueViewCount"])
        && request.resource.data.uniqueViewCount == currentViews + 1;
    }

    match /listings/{listingId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.landlordId == request.auth.uid;
      allow update: if isSignedIn() && (isLandlordForListing(listingId) || isUniqueViewIncrement());
      allow delete: if isSignedIn() && isLandlordForListing(listingId);

      match /views/{viewerId} {
        allow read: if isSignedIn()
          && (request.auth.uid == viewerId || isLandlordForListing(listingId));
        allow create: if isSignedIn()
          && request.auth.uid == viewerId
          && request.resource.data.viewerId == viewerId;
        allow update, delete: if false;
      }
    }

    match /users/{userId} {
      allow read: if isSignedIn() && request.auth.uid == userId;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId;
      allow delete: if false;
    }

    match /verifications/{userId} {
      allow read: if isSignedIn() && request.auth.uid == userId;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId;
      allow delete: if false;
    }
  }
}
